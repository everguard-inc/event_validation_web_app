{% extends 'base.html' %}
{% load static %}

{% block content %}
<form method="get" class="date-range-form">
    <label for="start_date">Start Date:</label>
    <input type="date" id="start_date" name="start_date" value="{{ request.GET.start_date }}">

    <label for="end_date">End Date:</label>
    <input type="date" id="end_date" name="end_date" value="{{ request.GET.end_date }}">

    <button type="submit">Filter</button>
</form>
<div class="container-fluid">
  <div style="width: 100%; overflow-x: auto;">
    <table>
        <thead>
            <tr>
                <th>Datetime</th>
                <th>Link</th>
                <th>Portal Status</th>
                <th>Portal Comment</th>
                <th>Internal Comment</th>
                <th>Internal Status</th>
                <th>Major Tag</th>
                <th>Minor Tag 1</th>
                <th>Minor Tag 2</th>
            </tr>
        </thead>
        <tbody id="object-list">
            {% for object in events %}
                <tr id="object-{{ object.id }}">
                    <td>{{ object.datetime }}</td>
                    <td>{{ object.link }}</td>
                    <td>{{ object.portal_comment }}</td>
                    <td>{{ object.portal_status }}</td>
                    <td>
                        <input type="text" value="{{ object.internal_comment }}"
                               data-id="{{ object.id }}"
                               data-field="internal_comment"
                               class="ajax-update">
                    </td>
                    <td>
                        <select data-id="{{ object.id }}"
                                data-field="internal_status"
                                class="ajax-update-select">
                            {% for value, display in status_choices %}
                                <option value="{{ value }}" {% if object.internal_status == value %}selected{% endif %}>
                                    {{ display }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select data-id="{{ object.id }}"
                                data-field="major_tag"
                                class="ajax-update-select">
                            {% for tag in tags %}
                                <option value="{{ tag.pk }}" {% if object.major_tag.pk == tag.pk %}selected{% endif %}>
                                    {{ tag.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select data-id="{{ object.id }}"
                                data-field="minor_tag1"
                                class="ajax-update-select">
                            {% for tag in tags %}
                                <option value="{{ tag.pk }}" {% if object.minor_tag1.pk == tag.pk %}selected{% endif %}>
                                    {{ tag.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select data-id="{{ object.id }}"
                                data-field="minor_tag2"
                                class="ajax-update-select">
                            {% for tag in tags %}
                                <option value="{{ tag.pk }}" {% if object.minor_tag2.pk == tag.pk %}selected{% endif %}>
                                    {{ tag.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var $j = jQuery.noConflict();

    $j(document).ready(function(){

        $j('.ajax-update').each(function() {
                $j(this).data('original-value', $j(this).val());
            });

        $j('.ajax-update').on('blur', function() {
            var element = $j(this);
            var value = element.val();
            var originalValue = element.data('original-value');
            var field = element.data('field');
            var id = element.data('id');

            // Only send AJAX if the value has changed
            if (value !== originalValue) {
                $j.ajax({
                    url: '{% url "event-update" 0 %}'.replace('0', id),
                    type: 'POST',
                    data: {
                        'name': field,
                        'value': value,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        $j(element).data('original-value', value);
                    },
                    error: function(response) {
                        console.log('Error updating field:', response);
                    }
                });
            } else {
                console.log('No changes detected, request not sent.');
            }
        });

        $j('.ajax-update-select').on('change', function() {
            var element = $j(this);
            var value = element.val();
            var originalValue = element.data('original-value');
            var field = element.data('field');
            var id = element.data('id');

            // Only send AJAX if the value has changed
            if (value !== originalValue) {
                $j.ajax({
                    url: '{% url "event-update" 0 %}'.replace('0', id),
                    type: 'POST',
                    data: {
                        'name': field,
                        'value': value,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        // Update the stored original value after a successful update
                        $j(element).data('original-value', value);
                    },
                    error: function(response) {
                        console.log('Error updating field:', response);
                    }
                });
            } else {
                console.log('No changes detected, request not sent.');
            }
        });
    });
</script>
{% endblock %}
